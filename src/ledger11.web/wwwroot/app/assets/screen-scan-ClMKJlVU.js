import{c as S,r as f,j as e,B as x,C as T,s as E,D as I,a as R,b as D,d as N,S as L,e as b,u as k,t as p,p as F,f as M}from"./index-BsiFfdWj.js";import{P}from"./PreferredLanguage-BYxrJ2fp.js";import{C as U,a as A,b as W,c as B,d as H}from"./card-CVy2jYUU.js";import{T as _}from"./TransactionRow-f7zJPdfl.js";import{T as $}from"./textarea-DQkKlopX.js";import"./command-WU1VhfgQ.js";import"./select-1wvw_FRm.js";/**
 * @license lucide-react v0.488.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],G=S("loader-circle",O);function X(a,s,d,g=.9){return new Promise((i,o)=>{if(!a.type.startsWith("image/"))return o(new Error("File is not an image."));const c=new Image,m=URL.createObjectURL(a);c.onload=()=>{const l=c.naturalWidth,r=c.naturalHeight;if(URL.revokeObjectURL(m),l<=s&&r<=d)return i(a);const n=Math.min(s/l,d/r),u=Math.round(l*n),t=Math.round(r*n),h=document.createElement("canvas");h.width=u,h.height=t;const j=h.getContext("2d");if(!j)return o(new Error("Failed to get 2D context from canvas."));j.imageSmoothingQuality="high",j.drawImage(c,0,0,u,t),h.toBlob(C=>{if(!C)return o(new Error("Canvas to Blob conversion failed."));const v=new File([C],a.name,{type:C.type||a.type,lastModified:Date.now()});i(v)},a.type.startsWith("image/jpeg")?"image/jpeg":a.type,a.type.startsWith("image/jpeg")?g:void 0)},c.onerror=l=>{URL.revokeObjectURL(m),o(new Error(`Image loading error: ${l}`))},c.src=m})}const w=480,y=640,z=({onCompletion:a,onError:s,buttonText:d="Scan Receipt",className:g})=>{const[i,o]=f.useState(!1),c=f.useRef(null),m=()=>{var r;i||(r=c.current)==null||r.click()},l=async r=>{var u;const n=(u=r.target.files)==null?void 0:u[0];if(r.target&&(r.target.value=""),!n){console.log("No file selected or file selection failed.");return}console.log("Image selected:",n.name),o(!0);try{console.log(`Attempting to scale image if larger than ${w}x${y}...`);const t=await X(n,w,y);console.log("Sending image to API...");const h=await E(t);console.log("API call successful, received records:",h),a(h)}catch(t){console.error("Error scanning receipt:",t),s&&s(t instanceof Error?t:new Error(String(t))),alert(`Error scanning receipt: ${t instanceof Error?t.message:String(t)}`)}finally{o(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:c,type:"file",accept:"image/*",capture:"environment",onChange:l,style:{display:"none"},disabled:i}),e.jsxs(x,{onClick:m,className:g,disabled:i,"aria-label":"Scan Receipt",children:[i?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(T,{className:"mr-2 h-4 w-4"}),i?"Scanning...":d," "]})]})};function Q({transaction:a,onConfirm:s,onUndo:d}){return e.jsx(I,{open:!0,children:e.jsxs(R,{className:"flex flex-col h-[90vh]",children:[e.jsx(D,{children:e.jsx(N,{children:"Confirm Transaction"})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(L,{className:"h-full w-full",children:e.jsx(_,{transaction:a,expanded:!0})})}),e.jsxs(b,{children:[e.jsx(x,{variant:"secondary",onClick:d,children:"Undo"}),e.jsx(x,{onClick:s,children:"Confirm"})]})]})})}function ne(){const[a,s]=f.useState(null),{categories:d,addTransaction:g,removeTransaction:i}=k(),[o,c]=f.useState(""),m=async n=>{const u=M(d,n);if(!u){p.error("Could not understand... try another language?");return}const t=await g(u);console.log("Master purchase:",t),s(t)},l=n=>{console.log("Scan completed successfully in parent."),m(n)},r=async()=>{if(o)try{const n=await F(o);m(n)}catch(n){p.error(`Cound not do it: ${n}`)}};return e.jsx("div",{className:"flex flex-col justify-center items-center px-4",children:e.jsxs("div",{className:"w-full max-w-md space-y-6",children:[e.jsx("div",{className:"pt-2",children:e.jsx(z,{buttonText:"Tap to Scan",onCompletion:l,className:"w-full py-6 text-lg rounded-xl"})}),e.jsx("h2",{className:"text-2xl font-bold text-center",children:"Or Describe It With Words"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx($,{rows:2,placeholder:"What have you purchased...",value:o,onChange:n=>c(n.target.value)}),e.jsx(x,{onClick:r,children:"Parse ..."})]}),e.jsxs(U,{children:[e.jsxs(A,{children:[e.jsx(W,{children:"Translate"}),e.jsx(B,{children:"If you want to translate the receipt, select your preferred language."})]}),e.jsx(H,{children:e.jsx(P,{})})]}),a&&e.jsx(Q,{transaction:a,onConfirm:()=>{s(null),p.success("Done!")},onUndo:()=>{s(null),i(a.id).catch(n=>{console.error("Error removing transaction:",n),p.error("Error removing transaction")})}})]})})}export{ne as default};
