import{c as T,r as f,j as e,B as x,C as I,s as E,u as v,D as R,a as D,b as N,d as L,S as F,e as M,f as b,t as p,p as k,g as P}from"./index-BNrXmEfu.js";import{P as U}from"./PreferredLanguage-BoiwvlhH.js";import{C as A,a as W,b as B,c as H,d as _}from"./card-f_af9cN7.js";import{T as $}from"./TransactionRow-B2kdC3BN.js";import{T as O}from"./textarea-B-XHzC0V.js";import"./command-CRF7QstB.js";import"./select-doCBs-N4.js";/**
 * @license lucide-react v0.488.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],X=T("loader-circle",G);function z(a,c,l,h=.9){return new Promise((s,r)=>{if(!a.type.startsWith("image/"))return r(new Error("File is not an image."));const i=new Image,m=URL.createObjectURL(a);i.onload=()=>{const g=i.naturalWidth,o=i.naturalHeight;if(URL.revokeObjectURL(m),g<=c&&o<=l)return s(a);const t=Math.min(c/g,l/o),u=Math.round(g*t),n=Math.round(o*t),d=document.createElement("canvas");d.width=u,d.height=n;const j=d.getContext("2d");if(!j)return r(new Error("Failed to get 2D context from canvas."));j.imageSmoothingQuality="high",j.drawImage(i,0,0,u,n),d.toBlob(C=>{if(!C)return r(new Error("Canvas to Blob conversion failed."));const S=new File([C],a.name,{type:C.type||a.type,lastModified:Date.now()});s(S)},a.type.startsWith("image/jpeg")?"image/jpeg":a.type,a.type.startsWith("image/jpeg")?h:void 0)},i.onerror=g=>{URL.revokeObjectURL(m),r(new Error(`Image loading error: ${g}`))},i.src=m})}const w=480,y=640,Q=({onCompletion:a,onError:c,buttonText:l="Scan Receipt",className:h})=>{const[s,r]=f.useState(!1),i=f.useRef(null),m=()=>{var o;s||(o=i.current)==null||o.click()},g=async o=>{var u;const t=(u=o.target.files)==null?void 0:u[0];if(o.target&&(o.target.value=""),!t){console.log("No file selected or file selection failed.");return}console.log("Image selected:",t.name),r(!0);try{console.log(`Attempting to scale image if larger than ${w}x${y}...`);const n=await z(t,w,y);console.log("Sending image to API...");const d=await E(n);console.log("API call successful, received records:",d),a(d)}catch(n){console.error("Error scanning receipt:",n),c&&c(n instanceof Error?n:new Error(String(n))),alert(`Error scanning receipt: ${n instanceof Error?n.message:String(n)}`)}finally{r(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:i,type:"file",accept:"image/*",capture:"environment",onChange:g,style:{display:"none"},disabled:s}),e.jsxs(x,{onClick:m,className:h,disabled:s,children:[s?e.jsx(X,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(I,{className:"mr-2 h-4 w-4"}),s?"Scanning...":l," "]})]})};function q({id:a,onConfirm:c,onUndo:l}){const{transactions:h}=v(),s=h.find(r=>r.id===a);return e.jsx(R,{open:!0,children:e.jsxs(D,{className:"flex flex-col h-[90vh]",children:[e.jsx(N,{children:e.jsx(L,{children:"Confirm Transaction"})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(F,{className:"h-full w-full",children:e.jsx($,{transaction:s,expanded:!0})})}),e.jsxs(M,{children:[e.jsx(x,{variant:"secondary",onClick:l,children:"Undo"}),e.jsx(x,{onClick:c,children:"Confirm"})]})]})})}function ne(){const{loadCategories:a}=b(),[c,l]=f.useState(0),{addTransaction:h,removeTransaction:s}=v(),[r,i]=f.useState(""),m=async t=>{const u=await a(),n=P(u,t);if(!n){p.error("Could not understand... try another language?");return}const d=await h(n);console.log("Master purchase ID:",d),l(d)},g=t=>{console.log("Scan completed successfully in parent."),m(t)},o=async()=>{if(r)try{const t=await k(r);m(t)}catch(t){p.error(`Cound not do it: ${t}`)}};return e.jsx("div",{className:"flex flex-col justify-center items-center px-4",children:e.jsxs("div",{className:"w-full max-w-md space-y-6",children:[e.jsx("div",{className:"pt-2",children:e.jsx(Q,{buttonText:"Tap to Scan",onCompletion:g,className:"w-full py-6 text-lg rounded-xl"})}),e.jsx("h2",{className:"text-2xl font-bold text-center",children:"Or Describe It With Words"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(O,{rows:2,placeholder:"What have you purchased...",value:r,onChange:t=>i(t.target.value)}),e.jsx(x,{onClick:o,children:"Parse ..."})]}),e.jsxs(A,{children:[e.jsxs(W,{children:[e.jsx(B,{children:"Translate"}),e.jsx(H,{children:"If you want to translate the receipt, select your preferred language."})]}),e.jsx(_,{children:e.jsx(U,{})})]}),c!==0&&e.jsx(q,{id:c,onConfirm:()=>{l(0),p.success("Done!")},onUndo:()=>{l(0),s(c).catch(t=>{console.error("Error removing transaction:",t),p.error("Error removing transaction")})}})]})})}export{ne as default};
