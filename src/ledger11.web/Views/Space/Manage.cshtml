@model List<ledger11.model.Data.Space>

@{
    ViewData["Title"] = "Manage Spaces";
    var currentId = TempData["current"]?.ToString();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .space-card {
        border: 1px solid #e0e0e0;
        border-radius: 1rem;
        padding: 1rem;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .space-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 12px rgba(13, 110, 253, 0.15);
    }

    .space-card.current {
        border-color: #0d6efd;
        background-color: #e9f5ff;
    }

    .space-card .menu {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }

    .dropdown-menu {
        min-width: 8rem;
    }

    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    @@media (max-width: 576px) {
        .space-card {
            padding: 0.8rem;
        }
    }
</style>

<h2 class="mb-4">Manage Your Spaces</h2>

<div class="card-grid mb-4">
    @if (!Model.Any())
    {
        <div class="text-muted">No spaces. Create a new one below...</div>
    }
    else
    {
        foreach (var space in Model)
        {
            var isCurrent = space.Id.ToString() == currentId;
            var cardClass = isCurrent ? "space-card current" : "space-card";

            <div class="@cardClass" onclick="handleCardClick(event, '@space.Id')">

                <form id="set-current-@space.Id" asp-action="SetCurrentSpace" method="post" class="d-none">
                    <input type="hidden" name="spaceId" value="@space.Id" />
                </form>

                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="mb-2">@space.Name</h5>
                    <div class="menu dropdown">
                        <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a href="#" class="dropdown-item"
                                    onclick="event.stopPropagation(); toggleRename('@space.Id')">Rename</a>
                            </li>
                            <li>
                                <form asp-action="DeleteSpace" method="post" onsubmit="return confirm('Are you sure?')">
                                    <input type="hidden" name="spaceId" value="@space.Id" />
                                    <button type="submit" class="dropdown-item text-danger"
                                        onclick="event.stopPropagation();">Delete</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="text-muted" style="font-size: 0.9em;">@space.CreatedAt.ToLocalTime().ToString("g")</div>

                <div id="rename-@space.Id" style="display: none;" class="mt-2">
                    <form asp-action="RenameSpace" method="post" onsubmit="event.stopPropagation();">
                        <input id="rename-input-@space.Id" type="hidden" name="spaceId" value="@space.Id" />
                        <div class="input-group input-group-sm">
                            <input type="text" name="newName" class="form-control" value="@space.Name" required />
                            <button type="submit" class="btn btn-secondary">Save</button>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="toggleRename('@space.Id')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
</div>

<div class="mt-5">
    <form asp-action="CreateSpace" method="post" class="row g-2 align-items-center">
        <div class="col-md-8 col-12 mb-2 mb-md-0">
            <input type="text" name="name" class="form-control" placeholder="New space name" required />
        </div>
        <div class="col-md-4 col-12">
            <button type="submit" class="btn btn-primary w-100">Create Space</button>
        </div>
    </form>
</div>

<script>
    function toggleRename(id) {
        event.stopPropagation();
        const el = document.getElementById(`rename-${id}`);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
</script>

<script>
    function handleCardClick(event, id) {
        // Don't trigger if the click is on or inside a button, form, dropdown, or input
        const tag = event.target.tagName.toLowerCase();
        const isInteractive = ['button', 'a', 'form', 'input', 'label', 'svg', 'path', 'select', 'textarea'].includes(tag) ||
            event.target.closest('.dropdown') || event.target.closest('form');
        if (!isInteractive) {
            document.getElementById(`set-current-${id}`).submit();
        }
    }

    function toggleRename(id) {
        event.stopPropagation();
        const el = document.getElementById(`rename-${id}`);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        setTimeout(() => {
            document.getElementById(`rename-input-${id}`).focus();
        }, 100);
    }
</script>


@* <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> *@
